<html>
   <head>
      <meta charset="utf-8">
      <script src="assets/js/jquery-3.7.1.js"></script>
      <script src="assets/bootstrap/js/bootstrap.min.js"></script>
   </head>
   <body>
      <div class="container" style="padding-left: 0px;padding-right: 0px;margin: 0px;margin-left: 20px;margin-bottom: 0px;margin-right: 0px;margin-top: 0px;max-width: 100%;">
          <div class="row" style="width:50%; margin-right: 10%;margin-left: 0px;">
              <div class="col">
                  <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="syslog_title_label">Системный журнал</p></span>
                  <div class="row" style="height: 50px; background: white; border: none; margin-bottom: 10px; align-items: center;"> 
                      <button id="download-syslog-button" type="button" class="btn" style="width: 43%; height: 100%; margin-right: 2%; color: white;">Скачать Syslog</button>
                      <button id="download-log-button" type="button" class="btn" style="width: 49%; height: 100%; margin-right: 2%; color: white;">Скачать cumanphone.log</button>
                  </div> 
                  <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="reboot_label">Перезагрузка</p></span> 
                  <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="reboot_os_label">Хотите выполнить перезагрузку телефона?</p></div>
                  <div class="row" style="height: 50px; background: white; border: none; margin-bottom: 10px; align-items: center;">
                      <button id="reloadButton" type="button" class="btn" style="width: 40%; height: 100%; margin-right: 2%; color: white; background: linear-gradient(180deg, #444444 0%, #0D1109 100%); border-radius: 10px; border: 1px white solid;">Перезагрузить</button>
                      <button id="restartButton" type="button" class="btn" style="width: 52%; height: 100%; margin-right: 2%; color: white; background: linear-gradient(180deg, #444444 0%, #0D1109 100%); border-radius: 10px; border: 1px white solid;">Перезагрузить приложение</button>
                  </div> 
                  <div class="row"><hr style="width:100%;" size="2" color="#9A9A9A" /></div> 
                  <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="update_title_label">Обновление ПО</p></span> 
                  <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="current_version_label">Текущая версия</p></div>
                  <div class="row" style="height: 50px; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; margin-bottom: 10px; align-items: center;"> 
                      <input id="version" readonly="readonly" style="width: 100%; height: 100%; border-radius: 10px; border: none; padding-left: 10px;">
                  </div>
                  <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="upload_version_label">Загрузка обновлений</p></div>
                  <div class="row" style="height: 50px; background: white; margin-bottom: 10px; align-items: center;"> 
                      <input id="update-file"  style="width: 73%; height: 100%; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; padding-left: 10px;">
                      <button id="choose-update-button" type="button" class="btn" style="width: 25%; height: 100%; color: white; background: #7BAF21; margin-left: 2%;">Обзор</button>
                  </div>
                  <div class="row" style="height: 50px; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; margin-bottom: 10px; align-items: center;"> 
                      <button id="update-button" type="button" class="btn" style="width: 100%; height: 100%; color: white; background: #7BAF21;">Обновить</button>
                  </div> 
                  <div class="row"><hr style="width:100%;" size="2" color="#9A9A9A" /></div> 
                  <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="factory_reset_label">Сброс до заводских настроек</p></span>  
                  <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="factory_reset_confirm_label">Вы уверены, что хотите сбросить телефон до заводских настроек?</p></div>
                  <div class="row" style="height: 50px; background: white; border: none; margin-bottom: 10px; align-items: center;"> 
                      <button id="reset-button" type="button" class="btn" style="width: 48%; height: 100%; margin-right: 2%; color: white;">Сбросить</button>
                  </div> 
              </div>
          </div>
      </div>
      <script type='text/javascript' src="assets/js/translation.js"></script>
      <script type='text/javascript'>
        document.getElementById('reboot-button-click').style.display = 'none';
        document.getElementById('restart-button-click').style.display = 'none';

        const modal = document.getElementById('reloadConfirm');
        const reloadButton = document.getElementById('reloadButton');
        const restartButton = document.getElementById('restartButton');
        const noButton = document.getElementById('re-no-click');

        reloadButton.addEventListener('click', function() {
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            document.getElementById('reboot-button-click').style.display = 'inline-block';
            document.getElementById('restart-button-click').style.display = 'none';
        });

        restartButton.addEventListener('click', function() {
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            document.getElementById('reboot-button-click').style.display = 'none';
            document.getElementById('restart-button-click').style.display = 'inline-block';
        });

        document.getElementById('reboot-button-click').addEventListener('click', function() {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        });

        document.getElementById('restart-button-click').addEventListener('click', function() {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        });

        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
        });

        noButton.addEventListener('click', function() {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        });

         $(function() { 
             $.get("php/system.php", function(data, status) {
                 console.log("Data: " + data);
                 console.log("Status: " + status);
                 var json = JSON.parse(data); 
                 $('#version').val(json.version);  
             });
         });

         $('#download-syslog-button').on( "click", function() {
            var json = JSON.stringify({ command: 'download-syslog' });
            $.post('php/system.php', json, function(resp) {
                if ( !resp )
                    return;
                var tempLink = document.createElement("a");
                var tempBlob = new Blob([resp], {type: 'text/plain'});
                tempLink.setAttribute('href', URL.createObjectURL(tempBlob));
                tempLink.setAttribute('download', `syslog`);
                tempLink.click();
                URL.revokeObjectURL(tempLink.href);
            });
         });

         $('#download-log-button').on( "click", function() {
            var json = JSON.stringify({ command: 'download-log' });
            $.post('php/system.php', json, function(resp) {
                if ( !resp )
                    return;  
                var tempLink = document.createElement("a");
                var tempBlob = new Blob([resp], {type: 'text/plain'});
                tempLink.setAttribute('href', URL.createObjectURL(tempBlob));
                tempLink.setAttribute('download', `cumanphone1.log`);
                tempLink.click();
                URL.revokeObjectURL(tempLink.href);

            });
         });


         $('#reboot-button-click').on("click", function() { 
            var json = JSON.stringify({ command: 'reboot' });
            
            $.post('php/system.php', json, function(resp) {
                console.log(resp);
                var json = JSON.parse(resp);
                showRebootDialog(json.success);
            });
        });

        $('#restart-button-click').on("click", function() { 
            var json = JSON.stringify({ command: 'reset' });
            
            $.post('php/system.php', json, function(resp) {
                console.log(resp);
                var json = JSON.parse(resp);
                showRebootDialog(json.success);
            });
        });

         $('#choose-update-button').on( "click", function() {
             var fileDialog = $('<input type="file" accept=".sh,.bin,.tar.bz2">');
             fileDialog.click();
             fileDialog.on("change",setUpdateFile);
             return false;
         });

         var setUpdateFile = function(e){
             console.log($(this)[0].files);
             if ($(this)[0].files && $(this)[0].files[0]) {
                 window.update = $(this)[0].files[0];     
                 $('#update-file').val($(this)[0].files[0].name);
             }
         };

         $('#update-button').on( "click", function() {
             console.log(window.update);
             var reader;
             if (window.update) { 
                 reader = new FileReader();
                 reader.onload = function(e) {
                    var data = {command: "update",
                                filename: window.update.name,
                                content: e.target.result};
                    var json = JSON.stringify(data);
                    $.post('php/system.php', json, function(resp) {
                        console.log(resp);
                    });
                    $('#update-file').val(''); 
                 }
                 reader.readAsDataURL(window.update);
             }
         });

      </script>
  </body>
</html>
