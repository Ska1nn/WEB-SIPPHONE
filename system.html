<html>
   <head>
      <meta charset="utf-8">
      <script src="assets/js/jquery-3.7.1.js"></script>
      <script src="assets/bootstrap/js/bootstrap.min.js"></script>
   </head>
<body>
    <div class="container" style="padding-left: 0px;padding-right: 0px;margin: 0px;margin-left: 20px;margin-bottom: 0px;margin-right: 0px;margin-top: 0px;max-width: 100%;">
        <div class="row" style="width:50%; margin-right: 10%;margin-left: 0px;">
            <div class="col">
                <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="reboot_label">Перезагрузка</p></span> 
                <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="reboot_os_label">Хотите выполнить перезагрузку телефона?</p></div>
                <div class="row" style="height: 50px; background: white; border: none; margin-bottom: 10px; align-items: center;">
                    <button id="reloadButton" type="button" class="btn" style="width: 40%; height: 100%; margin-right: 2%; color: white; background: linear-gradient(180deg, #444444 0%, #0D1109 100%); border-radius: 10px; border: 1px white solid;">Перезагрузить</button>
                    <button id="restartButton" type="button" class="btn" style="width: 52%; height: 100%; margin-right: 2%; color: white; background: linear-gradient(180deg, #444444 0%, #0D1109 100%); border-radius: 10px; border: 1px white solid;">Перезагрузить приложение</button>
                </div> 
                <div class="row"><hr style="width:100%;" size="2" color="#9A9A9A" /></div> 
                <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="update_title_label">Обновление ПО</p></span>
                <div class="col">
                    <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"></div>
                    <div class="row" style="height: 50px; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; margin-bottom: 10px; align-items: center; padding-right: 2%;">
                    <div class="col" id="auto-text" style="color: #6C6C6C; font-size: 18px; font-family: Gilroy; font-weight: 500; padding-left: 10px;">Автообновление</div>
                    <input type="checkbox" id="auto-check">
                </div>
                <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="current_version_label">Текущая версия</p></div>
                <div class="row" style="height: 50px; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; margin-bottom: 10px; align-items: center;"> 
                    <input id="version" readonly="readonly" style="width: 100%; height: 100%; border-radius: 10px; border: none; padding-left: 10px;">
                </div>
                <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="server-obnov-text">Сервер обновления</p></div>
                <div class="row" style="height: 50px; background: white; margin-bottom: 10px; align-items: center;"> 
                    <input id="server-obnov-check"  style="width: 100%; height: 100%; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; padding-left: 10px;">
                </div>
                <div class="row" style="height: 50px; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; margin-bottom: 10px; align-items: center;"> 
                    <button id="save-button" type="button" class="btn" style="width: 100%; height: 100%; color: white; background: #7BAF21;">Сохранить</button>
                </div>
                <div class="row"><hr style="width:100%;" size="2" color="#9A9A9A" /></div> 

                <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="ca-sertificat-text">CA-сертификат (TLS)</p></span>

                <div style="color: #6C6C6C; font-size: 18px; margin-left: -.75rem; margin-bottom: 10px;"><p id="sertificat-text-info">Загрузите корневой сертификат (.crt или .pem)</p></div>

                <div class="row" style="height: 50px; margin-bottom: 10px;display: flex;     justify-content: space-between; align-items: center;">
                    <input type="file" id="ca-file" accept=".crt,.pem" style="display:none;">

                    <div>
                        <button id="choose-ca-btn" class="btn" 
                            style="background:#444; color:white;">
                        <span id="choose-file-text">Выбрать файл</span>
                        </button>

                        <span id="selected-file-name" 
                            style="margin-left:10px; font-size:14px; color:#6C6C6C;">
                            Файл не выбран
                        </span>
                    </div>
                    <button id="upload-ca-btn" class="btn" style="background:#7BAF21; color:white;">
                        Загрузить
                    </button>
                </div>
                
                <div class="row"><hr style="width:100%;" size="2" color="#9A9A9A" /></div> 
                <div class="col">
                    <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="usb-port-name">USB-порт</p></div>
                    <div class="row" style="height: 50px; background: white; border-radius: 10px; border: 1px #D9D9D9 solid; margin-bottom: 10px; align-items: center; padding-right: 2%;">
                    <div class="col" id="usb-toggle-label" style="color: #6C6C6C; font-size: 18px; font-family: Gilroy; font-weight: 500; padding-left: 10px;">
                        <p id="usb-status-text-enabled" style="display: none;">Включен</p>
                        <p id="usb-status-text-disabled" style="display:none;">Выключен</p>
                    </div>
                    <input type="checkbox" id="toggle-usb-button">
                </div>
                </div>
                    <div class="row"><hr style="width:100%;" size="2" color="#9A9A9A" /></div> 
                    <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;"><p id="factory_reset_label">Сброс до заводских настроек</p></span>  
                    <div style="color: #6C6C6C; font-size: 20px; font-family: Gilroy; font-weight: 500; line-height: 30px; margin-left: -.75rem; margin-bottom: 10px;"><p id="factory_reset_confirm_label">Вы уверены, что хотите сбросить телефон до заводских настроек?</p></div>
                    <div class="row" style="height: 50px; background: white; border: none; margin-bottom: 10px; align-items: center;"> 
                        <button id="reset-button" type="button" class="btn" style="width: 48%; height: 100%; margin-right: 2%; color: white;">Сбросить</button>
                    </div> 
                </div>
            </div>
        </div>
    <script type='text/javascript' src="assets/js/translation.js"></script>
    <script type='text/javascript' src="assets/js/dialog.js"></script>
    <script type='text/javascript'>
        console.clear();
        $(function() { 
            $.get("php/system.php", function(data) {
                $('#version').val(data.version);
                $('#auto-check').prop('checked', data.autoupdate == 1);
                $('#server-obnov-check').val(data.domain);
            }, 'json');
        });
        $(function () {
            $.ajax({
                url: 'php/system.php',
                type: 'POST',
                data: JSON.stringify({ command: 'get_usb_state' }),
                contentType: 'application/json',
                dataType: 'json',
                success: function (result) {

                    const state = result.state === 1 ? 1 : 0;

                    $('#toggle-usb-button').prop('checked', state === 1);
                    $('#usb-status-text-enabled').toggle(state === 1);
                    $('#usb-status-text-disabled').toggle(state === 0);
                }
            });
        });

    $('#save-button').on("click", function () {
        var data = {
            command: 'save',
            autoupdate: $('#auto-check').prop('checked') ? 1 : 0,
            domain: $('#server-obnov-check').val()
        };
        console.log("Сохраняем:", data);
        $.ajax({
            url: 'php/system.php',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            dataType: 'json',
            success: function (json) {
                showDialog(json.success, true);
            }
        });
    });
    $('#toggle-usb-button').on('change', function () {
        const state = $(this).prop('checked') ? 1 : 0;
        $.ajax({
            url: 'php/system.php',
            type: 'POST',
            data: JSON.stringify({ command: 'toggle_usb', state }),
            contentType: 'application/json',
            dataType: 'json',
            success: function (result) {

                if (result.success === 1) {

                    $('#usb-modal-text-enabled').toggle(state === 1);
                    $('#usb-modal-text-disabled').toggle(state === 0);
                    $('#usbStatusModal').modal('show');

                    $('#usb-status-text-enabled').toggle(state === 1);
                    $('#usb-status-text-disabled').toggle(state === 0);

                } else {
                    alert('Ошибка: ' + result.output);
                }
            }
        });
    });
$('#choose-ca-btn').on('click', function () {
    $('#ca-file').click();
});

$('#ca-file').on('change', function () {
    if (this.files.length > 0) {
        $('#selected-file-name').text(this.files[0].name);
    } else {
        $('#selected-file-name').text(window.translations?.no_file || "Файл не выбран");
    }
});
$('#upload-ca-btn').on('click', function () {

    const fileInput = document.getElementById('ca-file');
    if (!fileInput.files.length) {
        alert("Выберите файл сертификата");
        return;
    }

    const file = fileInput.files[0];

    const allowedExtensions = ['crt', 'pem'];
    const ext = file.name.split('.').pop().toLowerCase();

    if (!allowedExtensions.includes(ext)) {
        alert("Разрешены только файлы .crt и .pem");
        return;
    }

    const formData = new FormData();
    formData.append('command', 'upload_ca');
    formData.append('file', file);

    $.ajax({
        url: 'php/system.php',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        dataType: 'json',
        success: function (json) {
            alert(json.message);
        }
    });
});
        </script>
    </body>
</html>
