<html>
   <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
        <script src="assets/js/jquery-3.7.1.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <style>
        input[type="radio"] {
            display: none;
        }
        label.key-box-label {
            width: 100%;
        }
        .key-box {
            border-radius: 10px;
            width: 100%;
            background-color: #6C6C6C; /* Серый фон */
            color: white; /* Белый текст */
            font-weight: 100;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            padding: 5px;
        }
        .sta-ind-info {
            display: flex;
            align-items: center;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 50px;
            border-radius: 10px;
            /* margin-bottom: 5px; */
            background-color: #888;
        }
        .status-indicator.active {
            background-color: #7BAF21;
        }
      
        .nav-buttons {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }
        .nav-buttons button {
            color: white;
            background: #7BAF21;
            width: 100px;
            height: 30px;
            border: none;
            border-radius: 10px;
        }
        .key-status {
          font-size: 0.85em;
          margin-top: 5px;
          opacity: 0.9;
        }
        .indicator-blfkey {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nbn-infob {
            margin: 0 0 0 10px;
        }
        .key-box.selected {
            border: 2px solid #7fc900;
            padding: 3px;
            box-shadow: 0 0 12px rgba(127, 201, 0, 0.7);
            transition: box-shadow 0.3s ease;
        }
      </style>
   </head>
   <body>
      <div class="container" style="padding-left: 0px;padding-right: 0px;margin: 0px;margin-left: 20px;margin-bottom: 0px;margin-right: 0px;margin-top: 0px;max-width: 100%;">
          <div class="row" style="width:40%; margin-right: 10%;margin-left: 0px;">
              <div class="col">
                <div class="row" id="blf-grid" style="display: flex; flex-wrap: wrap; gap: 5px; padding: 10px;"></div>

                <div class="nav-buttons">
                    <button onclick="prevPage()">Назад</button>
                    <span id="page-indicator">1</span>
                    <button onclick="nextPage()">Вперёд</button>
                </div>
              </div>
          </div>
      </div>

      <!-- Модальное окно -->
      <div class="modal fade" id="blfModal" tabindex="-1" role="dialog" aria-labelledby="blfModalLabel" aria-hidden="true" style="margin-top: -10%;">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body" style="padding: 30px;">
              <h5 class="modal-title" style="text-align: center; margin-bottom: 20px;">
                Настройка BLF клавиши <span id="modal-key-number"></span>
              </h5>
              <div style="margin-bottom: 15px;">
                <div style="color: #6C6C6C; font-size: 18px; font-weight: 500;">Тип клавиши</div>
                <select id="type" class="form-control" style="font-size: 18px; font-weight: 500;">
                  <option value="0" id="BLF-1">BLF</option>
                  <option value="1" id="speed-dial">Быстрый набор</option>
                </select>
              </div>
      
              <div style="margin-bottom: 15px;">
                <div style="color: #6C6C6C; font-size: 18px; font-weight: 500;">Учетная запись</div>
                <select id="account" class="form-control" style="font-size: 18px; font-weight: 500;">
                  <option value="" disabled selected>Выберите учетную запись</option>
                </select>
              </div>
      
              <div style="margin-bottom: 15px;">
                <div style="color: #6C6C6C; font-size: 18px; font-weight: 500;">Имя</div>
                <input id="name" class="form-control" style="font-size: 18px; font-weight: 500;" />
              </div>
      
              <div style="margin-bottom: 25px;">
                <div style="color: #6C6C6C; font-size: 18px; font-weight: 500;">Номер</div>
                <input id="number" class="form-control" style="font-size: 18px; font-weight: 500;" />
              </div>
      
              <div class="row">
                <div class="col text-center">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button id="res-blf-button" type="button" class="btn" style="color: white; background: #EA3535; margin-left: 10px;">Сбросить</button>
                    <button id="save-button" type="button" class="btn" style="color: white; background: #7BAF21; margin-left: 10px;">Сохранить</button>
                </div>
              </div>
      
            </div>
          </div>
        </div>
      </div>
      

    <!-- <nav id="side-button" class="navbar navbar-expand-md navbar-dark fixed-right" style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
        <div style="display: flex; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px;">
            <button id="save-button" type="button" class="btn" style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center;">
                Сохранить
            </button>
            <button id="cancel-button" type="button" class="btn" style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center;">
                Сбросить
            </button>
            <button id="restart-button" type="button" class="btn" style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center; border-radius: .35rem;">
                Перезагрузить
            </button>
        </div>
    </nav> -->

    <script src="assets/js/translation.js"></script>
    <script type='text/javascript'>
    (function () {
        console.clear();
        $(document).ready(function () {
            $.ajax({
                url: 'php/blf.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('Account Data:', response.accounts);

                    var accountSelect = $('#account');
                    accountSelect.empty();

                    response.accounts.forEach(function(accountObj) {
                        if (accountObj.account && (accountObj.name || accountObj.account)) {
                            var option = document.createElement('option');
                            option.value = accountObj.account;
                            option.textContent = accountObj.name || accountObj.account;
                            accountSelect.append(option);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                }
            });
        });

        var json;

        function load() {
            $.get("php/blf.php", function(data, status) {
                console.log("Data: " + data);
                console.log("Status: " + status);
                json = JSON.parse(decodeURIComponent(data)); 

                if ("accounts" in json) {
                    $.each(json.accounts, function(i, item) {
                        $('#account').append(new Option(item, item)); 
                    });                     
                }
                if ("blf" in json) {
                    key = $('.key-box-label').val();
                    $('.key-box-label').val(key).trigger('change');
                    renderKeys();
                }
            });
        }

        $(function() { load() });

        const totalKeys = 66;
        const keysPerPage = 11;
        let currentPage = 1;
        
        function renderKeys() {
            const container = document.getElementById("blf-grid");
            container.innerHTML = "";

            const start = (currentPage - 1) * keysPerPage + 1;
            const end = Math.min(currentPage * keysPerPage, totalKeys);

            for (let i = start; i <= end; i++) {
                const keyId = `BLF${i}`;
                const blfData = json && json.blf && json.blf[keyId] ? json.blf[keyId] : null;
                const isActive = !!blfData;

                const keyWrapper = document.createElement("label");
                keyWrapper.className = `key-box-label`;

                keyWrapper.innerHTML = `
                    <div id="blf-key-${i}" class="key-box">
                        <div class="indicator-blfkey">
                            <div class="sta-ind-info">
                                <div class="status-indicator ${isActive ? 'active' : ''}"></div>
                                <div class="nbn-infob">
                                    <div class="name-blf">Имя: ${blfData?.name || 'Имя не указано'}</div>
                                    <div>Номер: ${blfData?.number || 'Номер не указано'}</div>
                                </div>
                            </div>
                            <div><strong>Клавиша ${i}</strong></div>
                            <input type="radio" name="blf-key" value="${i}" />
                        </div>
                    </div>
                `;

                // Обработчик клика на input
                keyWrapper.querySelector('input').addEventListener('change', function () {
                    // Снимаем selected со всех .key-box
                    document.querySelectorAll('.key-box').forEach(el => {
                        el.classList.remove('selected');
                    });

                    // Ставим selected только на выбранную
                    this.closest('.key-box').classList.add('selected');

                    const data = json?.blf?.[keyId];

                    $('#type').val(data?.type || '0');
                    $('#account').val(data?.account || '');
                    $('#name').val(data?.name || '');
                    $('#number').val(data?.number || '');

                    $('.key-box-label').val(i);

                    $('#modal-key-number').text(i);
                    $('#modal-key-name').val(data?.name || '');
                    $('#modal-key-number-input').val(data?.number || '');

                    $('#blfModal').modal('show');

                    $('#save-blf-key').data('key-id', keyId);
                });

                container.appendChild(keyWrapper);
            }

            document.getElementById("page-indicator").textContent = currentPage;
        }

        function nextPage() {
        const totalPages = Math.ceil(totalKeys / keysPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderKeys();
        }
        }

        function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderKeys();
        }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // renderKeys();
        });

        $('.key-box-label').change(function() {
            if ( "blf" in json ) {
                var key = "BLF"+ $('.key-box-label').val();
                console.log(json.blf[key]);   
                if ( key in json.blf ) {
                    $('#type').val(json.blf[key].type);
                    $('#account').val(json.blf[key].account);
                    $('#name').val(json.blf[key].name);
                    $('#number').val(json.blf[key].number);
                    show();  
                }
                else {
                    $('#name').val('');
                    $('#number').val('');
                    hide();
                } 
            } 
        });

        $('#blfModal').on('shown.bs.modal', function () {
            $(this).attr('aria-hidden', 'false');
        });

        $('#blfModal').on('hidden.bs.modal', function () {
            $('input[name="blf-key"]').prop('checked', false);
            $('.key-box').removeClass('selected');
        });


        $('#cancel-button').on( "click", function() {
            $('#content').load("calls.html");  
        });
        $('#restart-button').on( "click", function() { 
                var json = JSON.stringify({ command: 'restart' });
                $.post('php/system.php', json, function(resp) {
                    console.log(resp);
                    var json = JSON.parse(resp);
                    showRestartDialog(json.success); 
                });
            });
        $('#save-button').on("click", function () {
            var error = false;
            var account = $('#account').val();
            var number = $('#number').val();
            var name = $('#name').val();

            if (!account || account.length == 0) {
                $('#account').css({ "border": "1px red solid" });
                error = true;
            } else {
                $('#account').css({ "border": "" });
            }

            if (number.length == 0) {
                $('#number').css({ "border": "1px red solid" });
                error = true;
            } else {
                $('#number').css({ "border": "" });
            }


            if (error) {
                showNotCompleteDialog();
                return;
            }

            var data = {
                command: 'save',
                key: $('.key-box-label').val(),
                type: $('#type').val(),
                account: $('#account').val(),
                name: $('#name').val(),
                number: $('#number').val()
            };

            var json = JSON.stringify(data);
            console.log(json);

            $.post('php/blf.php', json, function (resp) {
                console.log(resp);
                var json = JSON.parse(resp);
                showDialog(json.success, true);
                load();

                $('#blfModal').modal('hide');
            });
        });

        document.getElementById('res-blf-button').addEventListener('click', function () {
            var selectedKey = $('.key-box-label').val();
            if (!selectedKey) {
                $('#blfModal').modal('hide');
                return;
            }

            var keyData = json?.blf?.['BLF' + selectedKey];

            if (!keyData) {
                $('#blfModal').modal('hide');
                return;
            }

            var request = {
                command: 'reset',
                key: selectedKey
            };

            $.post('php/blf.php', JSON.stringify(request), function (resp) {
                console.log(resp);
                var json = JSON.parse(resp);
                showDialog(json.success, true);
                load();
                $('#blfModal').modal('hide');
            });
        });

        console.log($('.key-box-label').val());
    })();
    </script>
</body>
</html>
