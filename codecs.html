<html>
<head>
    <meta charset="utf-8">
    <script src="assets/js/jquery-3.7.1.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</head>
<style>
    .col.codec-columne {
        display: flex;
        margin: 30px 0 0;
        width: 50px;
        justify-content: center;
        align-items: center;
    }
    .hidden-section {
        display: none !important;
    }
    input.codec-enable[data-fixed="true"] {
        cursor: not-allowed !important;
        opacity: 0.6;
    }
    input.video-priority-lock {
        background-color: #e9ecef !important;
        cursor: not-allowed !important;
        opacity: 0.6;
        pointer-events: none;
        border: 1px solid #ced4da;
    }
</style>
<body>
    <div class="container" style="padding-left: 0px;padding-right: 0px;margin: 0px;margin-left: 20px;margin-bottom: 0px;margin-right: 0px;margin-top: 0px;max-width: 100%;">
        
        <div class="row audio-section-row" style="width:40%; margin-right: 10%;margin-left: 0px;">
            <div id="audio-codecs-column" class="col">
                <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;">
                    <p id="audio_codec_label">–ê—É–¥–∏–æ–∫–æ–¥–µ–∫</p>
                </span>

                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="g711a-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="g711a" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="G.711a" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="g711u-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="g711u" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="G.711u" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="g722-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="g722" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="G.722" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="g729-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="g729" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="G.729" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="opus-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="opus" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="OPUS" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="speex-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="speex" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="SPEEX" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="g726-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="g726" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="G.726" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="ilbc-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="ilbc" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="iLBC" disabled>
                    </div>
                </div>
                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="g723-enable" class="codec-enable" type="checkbox">
                    </div>
                    <div class="col">
                        <input id="g723" class="priority" type="number" min="1" max="9">
                    </div>
                    <div class="col">
                        <input class="codec" value="G.723" disabled>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row video-section-row" style="width:40%; margin-right: 10%;margin-left: 0px;">
            <div id="video-codecs-column" class="col">
                <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;">
                    <p id="video_codec_label">–í–∏–¥–µ–æ–∫–æ–¥–µ–∫</p>
                </span>

                <div class="row codec-row">
                    <div class="col codec-columne">
                        <input id="h264-enable" class="codec-enable" type="checkbox" data-fixed="true" checked>
                    </div>
                    <div class="col">
                        <input id="h264" class="priority priority-video video-priority-lock" type="number" min="1" max="1" value="1" disabled>
                    </div>
                    <div class="col">
                        <input class="codec" value="H264" disabled>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav id="side-button" class="navbar navbar-expand-md navbar-dark fixed-right" style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px;">
            <button id="save-button" type="button" class="btn" style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center;">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button id="cancel-button" type="button" class="btn" style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center;">
                –°–±—Ä–æ—Å–∏—Ç—å
            </button>
            <button id="restart-button" type="button" class="btn" style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center; border-radius: .35rem;">
                –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
        </div>
    </nav>
<script type='text/javascript' src="assets/js/translation.js"></script>
<script type='text/javascript'>
console.clear();

$(function() {
    var accountData = JSON.parse(localStorage.getItem('account') || '{}');
    var codecType = accountData.codecType;
    
    console.log('üìã codecType –∏–∑ account:', codecType);
    
    if (codecType === 'audio') {
        $('.video-section-row').hide();
        console.log('üîí –°–∫—Ä—ã—Ç –±–ª–æ–∫ –í–ò–î–ï–û (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ)');
    } else if (codecType === 'video') {
        $('.audio-section-row').hide();
        console.log('üîí –°–∫—Ä—ã—Ç –±–ª–æ–∫ –ê–£–î–ò–û (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ)');
    } else {
        console.log('üì¢ –ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –±–ª–æ–∫–∏ (codecType –Ω–µ —É–∫–∞–∑–∞–Ω)');
    }

    var codecs = '';
    
    if (codecType === 'audio' && accountData.audioCodecs) {
        codecs = accountData.audioCodecs;
        console.log('üì• –ó–∞–≥—Ä—É–∂–µ–Ω—ã –∞—É–¥–∏–æ–∫–æ–¥–µ–∫–∏:', codecs);
    } else if (codecType === 'video' && accountData.videoCodecs) {
        codecs = accountData.videoCodecs;
        console.log('üì• –ó–∞–≥—Ä—É–∂–µ–Ω—ã –≤–∏–¥–µ–æ–∫–æ–¥–µ–∫–∏:', codecs);
    } else {
        if (codecType === 'audio') {
            codecs = 'g711a,g711u,g722,g729,opus,speex,g726,ilbc,g723';
        } else if (codecType === 'video') {
            codecs = 'h264';
        }
        console.log('üì• –ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–æ–¥–µ–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:', codecs);
    }
    
    console.log('üì¶ –ö–æ–¥–µ–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:', codecs);

    function norm(s){ 
        return String(s).toLowerCase().replace(/[^a-z0-9]/g,''); 
    }

    var codecsNorm = codecs.split(',').map(norm);

    function lockH264() {
        var $check = $('#h264-enable');
        var $input = $('#h264');
        if ($input.length) {
            $input.val(1).prop('disabled', true);
        }
        if ($check.length) {
            $check.prop('checked', true).prop('disabled', false);
        }
        console.log('üîí H264 –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω: checked=true, priority=1');
    }

    $("input.priority:not(.video-priority-lock)").each(function() {
        var $input = $(this);
        $input.val(0).prop("disabled", true);
        var id = $input.attr("id");
        var $checkbox = $("[id='" + id + "-enable'], [id='" + id.toUpperCase() + "-enable']");
        if ($checkbox.length && !$checkbox.data('fixed')) {
            $checkbox.prop("checked", false);
        }
    });

    var h264InList = false;
    
    for (var i = 0; i < codecsNorm.length; i++) {
        var id = codecsNorm[i];
        
        if (id === 'h264') {
            h264InList = true;
            lockH264();
            continue;
        }
        
        var index = i + 1;
        var $input = $('#' + id);
        
        if ($input.length && !$input.hasClass('video-priority-lock')) {
            $input.val(index).prop("disabled", false);
            var $checkbox = $("[id='" + id + "-enable'], [id='" + id.toUpperCase() + "-enable']");
            if ($checkbox.length && !$checkbox.data('fixed')) {
                $checkbox.prop("checked", true);
            }
            console.log('‚úÖ –ù–∞—à—ë–ª input:', id, '=> —Å—Ç–∞–≤–ª—é –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç', index);
        } else {
            console.warn('‚ö†Ô∏è Input –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:', id);
        }
    }
    
    if (codecType === 'video' && !h264InList) {
        lockH264();
    }

    $(".codec-enable").on("change", function() {
        if ($(this).data('fixed')) {
            $(this).prop('checked', true);
            console.log('‚õî H264 –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å');
            return false;
        }
        
        var id = $(this).attr("id").replace("-enable", "").toLowerCase();
        var $input = $("#" + id);

        if ($(this).is(":checked")) {
            var used = $("input.priority:not(.video-priority-lock)").map(function(){ 
                return parseInt($(this).val(), 10) || 0; 
            }).get();
            
            var pr = 1;
            while (used.includes(pr)) pr++;
            
            $input.val(pr).prop("disabled", false);
            console.log("‚úÖ –í—ã—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç", pr, "–¥–ª—è", id);
        } else {
            $input.val(0).prop("disabled", true);
            console.log("‚ùå –°–±—Ä–æ—à–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è", id);
        }
    });
});

$('#cancel-button').on("click", function() {
    $('#content').load("sip.html");  
});

$('#save-button').on("click", function() {
    var inputs = $("input.priority:not(.video-priority-lock)");   
    
    var priorities = $.map(inputs, function(input, idx) { 
        var $input = $(input);
        var val = parseInt($input.val(), 10) || 0;
        var $checkbox = $("#" + input.id + "-enable, #" + input.id.toUpperCase() + "-enable");

        if ($checkbox.prop("checked") && val > 0 && !$checkbox.data('fixed')) {
            return { 
                name: input.id, 
                priority: val, 
                order: idx
            };
        }
        return null;
    });

    var accountData = JSON.parse(localStorage.getItem('account') || '{}');

    if (accountData.codecType === 'video') {
        priorities.push({ name: 'h264', priority: 1, order: -1 });
        console.log('‚úÖ H264 –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
    }

    priorities.sort(function(a, b){
        if (a.priority === b.priority) {
            return a.order - b.order;
        }
        return a.priority - b.priority;
    });

    var codecs = priorities.map(p => p.name).join(',');
    console.log("üíæ –°–æ—Ö—Ä–∞–Ω—è—é –∫–æ–¥–µ–∫–∏:", codecs);
    
    window.codecs = codecs;
    
    if (accountData.codecType === 'audio') {
        accountData.audioCodecs = codecs;
        console.log('üìù –ê–£–î–ò–û: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ audioCodecs:', codecs);
    } else if (accountData.codecType === 'video') {
        accountData.videoCodecs = codecs;
        console.log('üìù –í–ò–î–ï–û: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ videoCodecs:', codecs);
    }
    
    localStorage.setItem('account', JSON.stringify(accountData));
    console.log("üìä –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage:", accountData);
    
    $('#content').load("sip.html");
});
</script>
</body>
</html>