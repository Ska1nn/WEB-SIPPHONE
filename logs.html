<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="assets/js/jquery-3.7.1.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <style>
        .log-entry {
            font-family: Consolas, Monaco, 'Courier New', monospace;
            font-size: 13px;
            padding: 5px 10px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .log-time { color: #777; font-size: 12px; }
        .log-level { font-weight: bold; font-size: 12px; }
        .log-level.INFO  { color: #1a73e8; }
        .log-level.WARN  { color: #f9ab00; }
        .log-level.ERROR { color: #d93025; }
        .log-level.DEBUG { color: #0f9d58; }

        #logContainer {
            margin-top: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .log-current-start {
            margin-top: 24px;
            position: relative;
        }

        .log-current-start::before {
            content: "";
            display: block;
            height: 1px;
            background: #e0e0e0;
            margin-bottom: 8px;
            margin-left: -10px;
            margin-right: -10px;
        }
        .log-save-success {
            background-color: #e8f5e9;
            border-left: 3px solid #4caf50;
            padding-left: 7px;
            font-weight: 500;
        }
        .log-save-success .log-level {
            color: #2e7d32 !important;
        }
        .log-save-failure {
            background-color: #ffebee;
            border-left: 3px solid #f44336;
            padding-left: 7px;
            font-weight: 500;
        }
        .log-save-failure .log-level {
            color: #c62828 !important;
        }
    </style>
</head>
<body>
<div class="container" style="margin-left:20px;max-width:100%;">
    <div class="row" style="margin-right:10%;">
        <div class="col">
            <span style="color:black; font-size: 20px; font-weight:bold; margin-left: -.75rem;" id="logs-web-title">Журнал событий веб-интерфейса</span>
            <div id="logContainer"></div>
        </div>
    </div>
</div>
<nav id="side-button" class="navbar navbar-expand-md navbar-dark fixed-right" style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
        <div style="display: flex; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 20px;">
            <button id="clearBtn" type="button" class="btn"  style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center;">Очистить логи</button>
            <button id="downloadBtn" type="button" class="btn"  style="display: flex; align-items: center; color: white; background: #9A9A9A; width: 155px; justify-content: center;">Скачать логи</button>
        </div>
    </nav>

<script src="assets/js/translation.js"></script>
<script src="assets/js/dialog.js"></script>

<script>
function escapeHtml(text) {
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function formatHumanTime(isoString) {
    if (!isoString) return '';
    try {
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return isoString;
        return date.toLocaleString();
    } catch {
        return isoString;
    }
}

function renderLogs() {
    const container = document.getElementById('logContainer');
    if (!container) return;

    let logs = [];
    try {
        const stored = localStorage.getItem('sipPhoneLogs');
        logs = stored ? JSON.parse(stored) : [];
        if (!Array.isArray(logs)) logs = [];
    } catch {
        logs = [];
    }

    const filteredLogs = logs.filter(log => {
        const msg = (log.message || '').trim();
        if (msg === '') return false;
        if (/^Page:\s*/.test(msg)) return false;
        return true;
    });

    const reversed = [...filteredLogs].reverse();
    let html = '';

    for (let i = 0; i < reversed.length; i++) {
        const log = reversed[i];
        const msg = (log.message || '').trim();
        const time = formatHumanTime(log.time || '');
        const level = (log.level || 'INFO').toUpperCase();

        let entryClass = level;

        try {
            const jsonStart = msg.indexOf('{');
            if (jsonStart !== -1) {
                const possibleJson = msg.slice(jsonStart);
                const parsed = JSON.parse(possibleJson);

                if (
                    parsed.command === "save" ||
                    parsed.success === 1 ||
                    parsed.success === "1"
                ) {
                    entryClass += ' log-save-success';
                } else if (
                    parsed.success === 0 ||
                    parsed.success === "0" ||
                    parsed.error !== undefined
                ) {
                    entryClass += ' log-save-failure';
                }
            }
        } catch (e) {
        }

        const isCurrentLine = /^Current:\s*\w+/.test(msg);
        if (isCurrentLine) {
            entryClass += ' log-current-start';
        }

        html += `
            <div class="log-entry ${entryClass}">
                <span class="log-time">${escapeHtml(time)}</span>
                <span class="log-level ${level}">[${level}]</span>
                ${escapeHtml(msg)}
            </div>`;
    }

    container.innerHTML = html;
}

function clearLogs() {
    if (confirm('Очистить все логи?')) {
        localStorage.removeItem('sipPhoneLogs');
        renderLogs();
    }
}

function downloadLogs() {
    let logs = [];
    try {
        const stored = localStorage.getItem('sipPhoneLogs');
        logs = stored ? JSON.parse(stored) : [];
        if (!Array.isArray(logs)) logs = [];
    } catch {
        logs = [];
    }

    if (logs.length === 0) {
        alert('Нет логов для скачивания.');
        return;
    }

    const text = logs.map(log => {
        const time = formatHumanTime(log.time || '');
        const level = (log.level || 'INFO').toUpperCase();
        return `${time} [${level}] ${log.message || ''}`;
    }).join('\n');

    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `sip_logs_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
}

$(document).ready(() => {
    renderLogs();

    // только один интервал — глобально управляемый
    const intervalId = safeInterval(renderLogs, 2000);

    // при выходе со страницы — всё чистим
    $(window).on('unload', () => clearInterval(intervalId));

    $('#clearBtn').on('click', clearLogs);
    $('#downloadBtn').on('click', downloadLogs);
});
</script>
</body>
</html>
